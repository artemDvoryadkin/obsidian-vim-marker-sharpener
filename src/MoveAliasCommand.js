import { __awaiter } from "tslib";
import { Notice, MarkdownView } from 'obsidian';
export class MoveAliasCommand {
    constructor() {
        this.id = 'move-alias';
        this.name = 'Move alias';
    }
    execute(app) {
        return __awaiter(this, void 0, void 0, function* () {
            const activeView = app.workspace.getActiveViewOfType(MarkdownView);
            if (!activeView) {
                new Notice('Активный редактор не найден.');
                return;
            }
            const editor = activeView.editor;
            const cursor = editor.getCursor();
            const currentLine = editor.getLine(cursor.line);
            const splitLine = currentLine.replace('-', '').split('->').map(part => part.trim());
            const alias = splitLine[0];
            const newFile = splitLine[1].slice(2, -2);
            const currentFile = activeView.file;
            const currentFileName = currentFile === null || currentFile === void 0 ? void 0 : currentFile.name.replace(/\.md$/, '');
            console.log(`Текущее название файла: ${currentFileName}`);
            console.log(`вводные данные`, { currentFileName, alias, newFile });
            const files = app.vault.getMarkdownFiles();
            console.log("Количество файлов в хранилище", files.length);
            const referencingFiles = [];
            const pagePatternRegexp = new RegExp(`\\[\\[(${currentFileName})\\|(${alias})\\]\\]|\\[(${alias})\\]\\((${currentFileName})\\)`, 'gi');
            console.log("Регулярное выражение:", pagePatternRegexp);
            const readPromises = files.map((file) => __awaiter(this, void 0, void 0, function* () {
                const content = yield app.vault.read(file);
                if (pagePatternRegexp.test(content)) {
                    referencingFiles.push(file.path);
                    const updatedContent = content.replace(pagePatternRegexp, (match, p1, p2, p3, p4) => {
                        if (p1) {
                            return match.replace(new RegExp(p1, 'i'), newFile);
                        }
                        else if (p4) {
                            return match.replace(new RegExp(p4, 'i'), newFile);
                        }
                        return match;
                    });
                    yield app.vault.modify(file, updatedContent);
                }
            }));
            yield Promise.all(readPromises);
            const newFilePath = files.find(file => file.path.includes(newFile + ".md"));
            if (newFilePath) {
                yield app.fileManager.processFrontMatter(newFilePath, (frontmatter) => {
                    if (!frontmatter.aliases) {
                        frontmatter.aliases = [];
                    }
                    if (!frontmatter.aliases.includes(alias)) {
                        frontmatter.aliases.push(alias);
                    }
                });
                console.log(`Алиас "${alias}" добавлен в frontmatter файла "${newFile}" через API`);
            }
            else {
                console.log(`Файл "${newFile}" не найден`);
            }
            editor.setLine(cursor.line, "");
            if (referencingFiles.length > 0) {
                const message = `Файлы, содержащие алиас ${alias}:\n${referencingFiles.join('\n')}`;
                new Notice(message);
                console.log(message);
            }
            else {
                const message = `Ссылок на алиас ${alias} не найдено`;
                new Notice(message);
                console.log(message);
            }
            new Notice(`Текущая строка: ${splitLine}`);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW92ZUFsaWFzQ29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk1vdmVBbGlhc0NvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBTyxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBR3JELE1BQU0sT0FBTyxnQkFBZ0I7SUFBN0I7UUFDQyxPQUFFLEdBQUcsWUFBWSxDQUFDO1FBQ2xCLFNBQUksR0FBRyxZQUFZLENBQUM7SUE0RXJCLENBQUM7SUExRU0sT0FBTyxDQUFDLEdBQVE7O1lBQ3JCLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDbkUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNqQixJQUFJLE1BQU0sQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO2dCQUMzQyxPQUFPO1lBQ1IsQ0FBQztZQUVELE1BQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7WUFDakMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2xDLE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRWhELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNwRixNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUUxQyxNQUFNLFdBQVcsR0FBRyxVQUFV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Q0YsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEtBQUssbUNBQW1DLE9BQU8sYUFBYSxDQUFDLENBQUM7WUFDckYsQ0FBQztpQkFBTSxDQUFDO2dCQUNQLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxPQUFPLGFBQWEsQ0FBQyxDQUFDO1lBQzVDLENBQUM7WUFFRCxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFaEMsSUFBSSxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ2pDLE1BQU0sT0FBTyxHQUFHLDJCQUEyQixLQUFLLE1BQU0sZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQ3BGLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3RCLENBQUM7aUJBQU0sQ0FBQztnQkFDUCxNQUFNLE9BQU8sR0FBRyxtQkFBbUIsS0FBSyxhQUFhLENBQUM7Z0JBQ3RELElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3RCLENBQUM7WUFFRCxJQUFJLE1BQU0sQ0FBQyxtQkFBbUIsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUM1QyxDQUFDO0tBQUE7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgTm90aWNlLCBNYXJrZG93blZpZXcgfSBmcm9tICdvYnNpZGlhbic7XG5pbXBvcnQgeyBDb21tYW5kIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBNb3ZlQWxpYXNDb21tYW5kIGltcGxlbWVudHMgQ29tbWFuZCB7XG5cdGlkID0gJ21vdmUtYWxpYXMnO1xuXHRuYW1lID0gJ01vdmUgYWxpYXMnO1xuXG5cdGFzeW5jIGV4ZWN1dGUoYXBwOiBBcHApOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBhY3RpdmVWaWV3ID0gYXBwLndvcmtzcGFjZS5nZXRBY3RpdmVWaWV3T2ZUeXBlKE1hcmtkb3duVmlldyk7XG5cdFx0aWYgKCFhY3RpdmVWaWV3KSB7XG5cdFx0XHRuZXcgTm90aWNlKCfQkNC60YLQuNCy0L3Ri9C5INGA0LXQtNCw0LrRgtC+0YAg0L3QtSDQvdCw0LnQtNC10L0uJyk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgZWRpdG9yID0gYWN0aXZlVmlldy5lZGl0b3I7XG5cdFx0Y29uc3QgY3Vyc29yID0gZWRpdG9yLmdldEN1cnNvcigpO1xuXHRcdGNvbnN0IGN1cnJlbnRMaW5lID0gZWRpdG9yLmdldExpbmUoY3Vyc29yLmxpbmUpO1xuXG5cdFx0Y29uc3Qgc3BsaXRMaW5lID0gY3VycmVudExpbmUucmVwbGFjZSgnLScsICcnKS5zcGxpdCgnLT4nKS5tYXAocGFydCA9PiBwYXJ0LnRyaW0oKSk7XG5cdFx0Y29uc3QgYWxpYXMgPSBzcGxpdExpbmVbMF07XG5cdFx0Y29uc3QgbmV3RmlsZSA9IHNwbGl0TGluZVsxXS5zbGljZSgyLCAtMik7XG5cblx0XHRjb25zdCBjdXJyZW50RmlsZSA9IGFjdGl2ZVZpZXcuZmlsZTtcblx0XHRjb25zdCBjdXJyZW50RmlsZU5hbWUgPSBjdXJyZW50RmlsZT8ubmFtZS5yZXBsYWNlKC9cXC5tZCQvLCAnJyk7XG5cdFx0Y29uc29sZS5sb2coYNCi0LXQutGD0YnQtdC1INC90LDQt9Cy0LDQvdC40LUg0YTQsNC50LvQsDogJHtjdXJyZW50RmlsZU5hbWV9YCk7XG5cblx0XHRjb25zb2xlLmxvZyhg0LLQstC+0LTQvdGL0LUg0LTQsNC90L3Ri9C1YCwgeyBjdXJyZW50RmlsZU5hbWUsIGFsaWFzLCBuZXdGaWxlIH0pO1xuXG5cdFx0Y29uc3QgZmlsZXMgPSBhcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuXHRcdGNvbnNvbGUubG9nKFwi0JrQvtC70LjRh9C10YHRgtCy0L4g0YTQsNC50LvQvtCyINCyINGF0YDQsNC90LjQu9C40YnQtVwiLCBmaWxlcy5sZW5ndGgpO1xuXHRcdGNvbnN0IHJlZmVyZW5jaW5nRmlsZXM6IHN0cmluZ1tdID0gW107XG5cblx0XHRjb25zdCBwYWdlUGF0dGVyblJlZ2V4cCA9IG5ldyBSZWdFeHAoYFxcXFxbXFxcXFsoJHtjdXJyZW50RmlsZU5hbWV9KVxcXFx8KCR7YWxpYXN9KVxcXFxdXFxcXF18XFxcXFsoJHthbGlhc30pXFxcXF1cXFxcKCgke2N1cnJlbnRGaWxlTmFtZX0pXFxcXClgLCAnZ2knKTtcblx0XHRjb25zb2xlLmxvZyhcItCg0LXQs9GD0LvRj9GA0L3QvtC1INCy0YvRgNCw0LbQtdC90LjQtTpcIiwgcGFnZVBhdHRlcm5SZWdleHApO1xuXG5cdFx0Y29uc3QgcmVhZFByb21pc2VzID0gZmlsZXMubWFwKGFzeW5jIChmaWxlKSA9PiB7XG5cdFx0XHRjb25zdCBjb250ZW50ID0gYXdhaXQgYXBwLnZhdWx0LnJlYWQoZmlsZSk7XG5cdFx0XHRpZiAocGFnZVBhdHRlcm5SZWdleHAudGVzdChjb250ZW50KSkge1xuXHRcdFx0XHRyZWZlcmVuY2luZ0ZpbGVzLnB1c2goZmlsZS5wYXRoKTtcblx0XHRcdFx0Y29uc3QgdXBkYXRlZENvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UocGFnZVBhdHRlcm5SZWdleHAsIChtYXRjaCwgcDEsIHAyLCBwMywgcDQpID0+IHtcblx0XHRcdFx0XHRpZiAocDEpIHtcblx0XHRcdFx0XHRcdHJldHVybiBtYXRjaC5yZXBsYWNlKG5ldyBSZWdFeHAocDEsICdpJyksIG5ld0ZpbGUpO1xuXHRcdFx0XHRcdH0gZWxzZSBpZiAocDQpIHtcblx0XHRcdFx0XHRcdHJldHVybiBtYXRjaC5yZXBsYWNlKG5ldyBSZWdFeHAocDQsICdpJyksIG5ld0ZpbGUpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRhd2FpdCBhcHAudmF1bHQubW9kaWZ5KGZpbGUsIHVwZGF0ZWRDb250ZW50KTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHRhd2FpdCBQcm9taXNlLmFsbChyZWFkUHJvbWlzZXMpO1xuXG5cdFx0Y29uc3QgbmV3RmlsZVBhdGggPSBmaWxlcy5maW5kKGZpbGUgPT4gZmlsZS5wYXRoLmluY2x1ZGVzKG5ld0ZpbGUgKyBcIi5tZFwiKSk7XG5cdFx0aWYgKG5ld0ZpbGVQYXRoKSB7XG5cdFx0XHRhd2FpdCBhcHAuZmlsZU1hbmFnZXIucHJvY2Vzc0Zyb250TWF0dGVyKG5ld0ZpbGVQYXRoLCAoZnJvbnRtYXR0ZXIpID0+IHtcblx0XHRcdFx0aWYgKCFmcm9udG1hdHRlci5hbGlhc2VzKSB7XG5cdFx0XHRcdFx0ZnJvbnRtYXR0ZXIuYWxpYXNlcyA9IFtdO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmICghZnJvbnRtYXR0ZXIuYWxpYXNlcy5pbmNsdWRlcyhhbGlhcykpIHtcblx0XHRcdFx0XHRmcm9udG1hdHRlci5hbGlhc2VzLnB1c2goYWxpYXMpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHRcdGNvbnNvbGUubG9nKGDQkNC70LjQsNGBIFwiJHthbGlhc31cIiDQtNC+0LHQsNCy0LvQtdC9INCyIGZyb250bWF0dGVyINGE0LDQudC70LAgXCIke25ld0ZpbGV9XCIg0YfQtdGA0LXQtyBBUElgKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5sb2coYNCk0LDQudC7IFwiJHtuZXdGaWxlfVwiINC90LUg0L3QsNC50LTQtdC9YCk7XG5cdFx0fVxuXG5cdFx0ZWRpdG9yLnNldExpbmUoY3Vyc29yLmxpbmUsIFwiXCIpO1xuXG5cdFx0aWYgKHJlZmVyZW5jaW5nRmlsZXMubGVuZ3RoID4gMCkge1xuXHRcdFx0Y29uc3QgbWVzc2FnZSA9IGDQpNCw0LnQu9GLLCDRgdC+0LTQtdGA0LbQsNGJ0LjQtSDQsNC70LjQsNGBICR7YWxpYXN9OlxcbiR7cmVmZXJlbmNpbmdGaWxlcy5qb2luKCdcXG4nKX1gO1xuXHRcdFx0bmV3IE5vdGljZShtZXNzYWdlKTtcblx0XHRcdGNvbnNvbGUubG9nKG1lc3NhZ2UpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zdCBtZXNzYWdlID0gYNCh0YHRi9C70L7QuiDQvdCwINCw0LvQuNCw0YEgJHthbGlhc30g0L3QtSDQvdCw0LnQtNC10L3QvmA7XG5cdFx0XHRuZXcgTm90aWNlKG1lc3NhZ2UpO1xuXHRcdFx0Y29uc29sZS5sb2cobWVzc2FnZSk7XG5cdFx0fVxuXG5cdFx0bmV3IE5vdGljZShg0KLQtdC60YPRidCw0Y8g0YHRgtGA0L7QutCwOiAke3NwbGl0TGluZX1gKTtcblx0fVxufSAiXX0=